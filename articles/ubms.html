<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overview of ubms • ubms</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Overview of ubms">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ubms</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.2.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/ubms.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/JAGS-comparison.html">Comparing models fit in ubms and JAGS</a>
    </li>
    <li>
      <a href="../articles/random-effects.html">Random effects in ubms</a>
    </li>
    <li>
      <a href="../articles/spatial-models.html">Spatial Models in ubms</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kenkellner/ubms/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><script src="ubms_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Overview of ubms</h1>
            <h3 data-toc-skip class="subtitle">
<b>U</b>nmarked <b>B</b>ayesian <b>M</b>odels with <b>S</b>tan</h3>
                        <h4 data-toc-skip class="author">Ken Kellner</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/kenkellner/ubms/blob/HEAD/vignettes/ubms.Rmd" class="external-link"><code>vignettes/ubms.Rmd</code></a></small>
      <div class="hidden name"><code>ubms.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<div class="section level3">
<h3 id="what-is-ubms">What is ubms?<a class="anchor" aria-label="anchor" href="#what-is-ubms"></a>
</h3>
<p><code>ubms</code> is an R package for fitting models of wildlife occurrence and abundance to with datasets where animals are not individually marked. It provides a nearly identical interface to the popular <code>unmarked</code> package <span class="citation">(Fiske, Chandler, and others <a href="#ref-Fiske_2011" role="doc-biblioref">2011</a>)</span>. Instead of using maximum likelihood to fit models (as with <code>unmarked</code>), models are fit in a Bayesian framework using <a href="https://mc-stan.org/" class="external-link">Stan</a> <span class="citation">(Carpenter et al. <a href="#ref-Carpenter_2017" role="doc-biblioref">2017</a>)</span>. It is generally expected that you are already familiar with <code>unmarked</code> when using <code>ubms</code>. You can download <code>ubms</code>, report issues, or help with development on <a href="https://github.com/kenkellner/ubms" class="external-link">Github</a>.</p>
</div>
<div class="section level3">
<h3 id="why-should-you-use-it">Why should you use it?<a class="anchor" aria-label="anchor" href="#why-should-you-use-it"></a>
</h3>
<p>There are several advantages to using <code>ubms</code> over <code>unmarked</code>. First, it is possible to include random effects in <code>ubms</code> models, which is not currently possible in <code>unmarked</code>. These are specified using the familiar syntax of <a href="https://cran.r-project.org/package=lme4" class="external-link">lme4</a> <span class="citation">(Bates et al. <a href="#ref-Bates_2015" role="doc-biblioref">2015</a>)</span>. Second, <code>ubms</code> generates posterior distributions for model parameters, including latent occupancy and abundance parameters. These can be useful for post-hoc analyses and diagnostics. Finally, fitting models with Stan gives you access to the large ecosystem of Stan-related tools, such as <a href="https://cran.r-project.org/package=loo" class="external-link">LOO</a> (leave-one-out-cross validation; <span class="citation">(Vehtari, Gelman, and Gabry <a href="#ref-Vehtari_2017" role="doc-biblioref">2017</a>)</span>).</p>
<p>Another alternative to <code>ubms</code> would be to fit models in an existing modeling language such as BUGS, <a href="https://mcmc-jags.sourceforge.io/" class="external-link">JAGS</a>, or directly in Stan. <code>ubms</code> abstracts away the complex process of defining and writing custom models in these languages which need to be updated each time you make changes to your model. It also provides many useful helper functions (e.g. <code>predict</code>) which would otherwise require custom code. Finally, because of Stan’s efficient sampler <span class="citation">(Hoffman and Gelman <a href="#ref-Hoffman_2014" role="doc-biblioref">2014</a>)</span> and because the underlying likelihoods in <code>ubms</code> are marginalized, <code>ubms</code> will often fit models much faster than equivalent models in BUGS or JAGS <span class="citation">(Yackulic et al. <a href="#ref-Yackulic_2020" role="doc-biblioref">2020</a>)</span>.</p>
</div>
<div class="section level3">
<h3 id="what-are-the-disadvantages">What are the disadvantages?<a class="anchor" aria-label="anchor" href="#what-are-the-disadvantages"></a>
</h3>
<p>Relative to <code>unmarked</code>, <code>ubms</code> has fewer types of models available. For example, models that incorporate temporary emigration (like <code>gdistsamp</code>) <span class="citation">(Chandler, Royle, and King <a href="#ref-Chandler2011" role="doc-biblioref">2011</a>)</span> are currently not available in <code>ubms</code>. Models should run much faster in <code>unmarked</code> as well. If you do not need one of the specific benefits of <code>ubms</code> described above, it makes sense to stick with <code>unmarked</code>. Even if you do plan to use <code>ubms</code>, it makes sense to test the models in <code>unmarked</code> first. The similar interface between the two packages makes this very easy, as you will see in the next section.</p>
<p>Relative to BUGS/JAGS/Stan, <code>ubms</code> is less flexible because you cannot customize your model structure. You are limited to the provided model types. Furthermore, you cannot currently customize prior distributions (although I plan to add this in the future in some form). Finally, writing your own BUGS/JAGS model can be valuable for gaining a deeper understanding of how a model works; <code>ubms</code>, like <code>unmarked</code>, is essentially a black box.</p>
<p>To summarize the advantages and disadvantages: I see <code>ubms</code> as an intermediate step along the continuum from <code>unmarked</code> to custom models in BUGS/JAGS. It is not meant to replace either approach but rather to supplement them, for situations when a Bayesian framework is needed and “off-the-shelf” model structures are adequate.</p>
</div>
</div>
<div class="section level2">
<h2 id="example-fitting-a-single-season-occupancy-model">Example: Fitting a single-season occupancy model<a class="anchor" aria-label="anchor" href="#example-fitting-a-single-season-occupancy-model"></a>
</h2>
<p>Occupancy models estimate the probability <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ψ</mi><annotation encoding="application/x-tex">\psi</annotation></semantics></math> that a species occupies a site, while accounting for detection probability <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">p &lt; 1</annotation></semantics></math><span class="citation">(MacKenzie et al. <a href="#ref-MacKenzie_2002" role="doc-biblioref">2002</a>)</span>. In order to estimate both <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math> and <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ψ</mi><annotation encoding="application/x-tex">\psi</annotation></semantics></math>, repeated observations (detection/non-detection data) at each site are required.</p>
<div class="section level3">
<h3 id="set-up-the-data">Set up the data<a class="anchor" aria-label="anchor" href="#set-up-the-data"></a>
</h3>
<p>First, load the dataset we’ll be using, which comes with <code>unmarked</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://groups.google.com/d/forum/unmarked" class="external-link">unmarked</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">crossbill</span><span class="op">)</span></span></code></pre></div>
<p>The <code>crossbill</code> dataset is a <code>data.frame</code> with many columns. It contains detection/non-detection data for the European crossbill (<em>Loxia curvirostra</em>) in Switzerland <span class="citation">(Schmid, Zbinden, and Keller <a href="#ref-Schmid_2004" role="doc-biblioref">2004</a>)</span>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">crossbill</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 267  58</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">crossbill</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "id"      "ele"     "forest"  "surveys" "det991"  "det992"  "det993" </span></span>
<span><span class="co">##  [8] "det001"  "det002"  "det003"  "det011"  "det012"  "det013"  "det021" </span></span>
<span><span class="co">## [15] "det022"  "det023"  "det031"  "det032"  "det033"  "det041"  "det042" </span></span>
<span><span class="co">## [22] "det043"  "det051"  "det052"  "det053"  "det061"  "det062"  "det063" </span></span>
<span><span class="co">## [29] "det071"  "det072"  "det073"  "date991" "date992" "date993" "date001"</span></span>
<span><span class="co">## [36] "date002" "date003" "date011" "date012" "date013" "date021" "date022"</span></span>
<span><span class="co">## [43] "date023" "date031" "date032" "date033" "date041" "date042" "date043"</span></span>
<span><span class="co">## [50] "date051" "date052" "date053" "date061" "date062" "date063" "date071"</span></span>
<span><span class="co">## [57] "date072" "date073"</span></span></code></pre>
<p>Check <code><a href="https://hmecology.github.io/unmarked/reference/crossbill.html" class="external-link">?crossbill</a></code> for details about each column. The first three columns <code>id</code>, <code>ele</code>, and <code>forest</code> are site covariates.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">site_covs</span> <span class="op">&lt;-</span> <span class="va">crossbill</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"ele"</span>, <span class="st">"forest"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>The following 27 columns beginning with <code>det</code> are the binary detection/non-detection data; 9 years with 3 observations per year. For this example we want to fit a single-season occupancy model; thus we will use only the first three columns (year 1) of <code>det</code> as our response variable <code>y</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">crossbill</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"det991"</span>,<span class="st">"det992"</span>,<span class="st">"det993"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   det991 det992 det993</span></span>
<span><span class="co">## 1      0      0      0</span></span>
<span><span class="co">## 2      0      0      0</span></span>
<span><span class="co">## 3     NA     NA     NA</span></span>
<span><span class="co">## 4      0      0      0</span></span>
<span><span class="co">## 5      0      0      0</span></span>
<span><span class="co">## 6     NA     NA     NA</span></span></code></pre>
<p>Note that missing values are possible. The final 27 columns beginning with <code>date</code> are the Julian dates for each observation. As with <code>y</code> we want only the first three columns corresponding to year 1.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">date</span> <span class="op">&lt;-</span> <span class="va">crossbill</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"date991"</span>,<span class="st">"date992"</span>,<span class="st">"date993"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Finally, we build our <code>unmarkedFrame</code> object holding our detection/non-detection data, site covariates, and observation covariates. Since we will conduct a single-season occupancy analysis, we need to use <code>unmarkedFrameOccu</code> specifically. The resulting <code>unmarkedFrame</code> can be used by both <code>unmarked</code> and <code>ubms</code>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hmecology.github.io/unmarked/reference/unmarkedFrameOccu.html" class="external-link">unmarkedFrameOccu</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">y</span>, siteCovs<span class="op">=</span><span class="va">site_covs</span>, obsCovs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>date<span class="op">=</span><span class="va">date</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">umf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Data frame representation of unmarkedFrame object.</span></span>
<span><span class="co">##    y.1 y.2 y.3 id  ele forest date.1 date.2 date.3</span></span>
<span><span class="co">## 1    0   0   0  1  450      3     34     59     65</span></span>
<span><span class="co">## 2    0   0   0  2  450     21     17     33     65</span></span>
<span><span class="co">## 3   NA  NA  NA  3 1050     32     NA     NA     NA</span></span>
<span><span class="co">## 4    0   0   0  4  950      9     29     59     65</span></span>
<span><span class="co">## 5    0   0   0  5 1150     35     24     45     65</span></span>
<span><span class="co">## 6   NA  NA  NA  6  550      2     NA     NA     NA</span></span>
<span><span class="co">## 7    0   0   0  7  750      6     26     54     74</span></span>
<span><span class="co">## 8    0   0   0  8  650     60     23     43     71</span></span>
<span><span class="co">## 9    0   0   0  9  550      5     21     36     56</span></span>
<span><span class="co">## 10   0   0   0 10  550     13     37     62     75</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="fit-a-model">Fit a model<a class="anchor" aria-label="anchor" href="#fit-a-model"></a>
</h3>
<div class="section level4">
<h4 id="fit-the-model-in-unmarked">Fit the model in unmarked<a class="anchor" aria-label="anchor" href="#fit-the-model-in-unmarked"></a>
</h4>
<p>First, we fit a null model (no covariates) in <code>unmarked</code> using the <code>occu</code> function. The <code>occu</code> function requires as input a double formula (for detection and occupancy, respectively) along with our <code>unmarkedFrame</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">fit_unm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hmecology.github.io/unmarked/reference/occu.html" class="external-link">occu</a></span><span class="op">(</span><span class="op">~</span><span class="fl">1</span><span class="op">~</span><span class="fl">1</span>, data<span class="op">=</span><span class="va">umf</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## occu(formula = ~1 ~ 1, data = umf)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Occupancy (logit-scale):</span></span>
<span><span class="co">##  Estimate    SE     z P(&gt;|z|)</span></span>
<span><span class="co">##    -0.546 0.218 -2.51  0.0121</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Detection (logit-scale):</span></span>
<span><span class="co">##  Estimate    SE     z P(&gt;|z|)</span></span>
<span><span class="co">##    -0.594 0.208 -2.86 0.00426</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## AIC: 511.2538 </span></span>
<span><span class="co">## Number of sites: 245</span></span>
<span><span class="co">## ID of sites removed due to NA: 3 6 38 63 71 106 116 118 125 126 152 163 168 178 181 197 199 212 218 220 238 257</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="fit-the-model-in-ubms">Fit the model in ubms<a class="anchor" aria-label="anchor" href="#fit-the-model-in-ubms"></a>
</h4>
<p>Next, we fit the same model in <code>ubms</code>. The equivalent to <code>occu</code> in <code>ubms</code> is <code>stan_occu</code>. Functions in <code>ubms</code> generally use this <code>stan_</code> prefix, based on the approach used in package <a href="https://cran.r-project.org/package=rstanarm" class="external-link">rstanarm</a> for GLMs. We need to provide the same arguments to <code>stan_occu</code>. In addition, we will specify that we want 3 MCMC chains (<code>chains=3</code>), with 500 iterations per chain (<code>iter=500</code>) of which the first half will be warmup iterations. It is beyond the scope of this vignette to discuss the appropriate number or length of chains; see <a href="https://mc-stan.org/docs/2_24/stan-users-guide/index.html" class="external-link">the Stan user’s guide</a> for more details. Generally 4 chains of 2000 iterations each is recommended (of which 1000 per chain are warmups). Thus, 500 iterations per chain is probably not enough, but to keep things running quickly it is sufficient for this vignette. Note that if you are more familiar with BUGS or JAGS, Stan generally requires a smaller number of iterations to reach convergence thanks to its default NUTS sampler <span class="citation">(Hoffman and Gelman <a href="#ref-Hoffman_2014" role="doc-biblioref">2014</a>)</span>. If you have a good multi-core CPU, you can run chains in parallel. Tell Stan how many parallel cores you want to use by assigning a value to the <code>cores</code> argument.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kenkellner.com/ubms/" class="external-link">ubms</a></span><span class="op">)</span></span>
<span></span>
<span><span class="op">(</span><span class="va">fit_stan</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_occu.html">stan_occu</a></span><span class="op">(</span><span class="op">~</span><span class="fl">1</span><span class="op">~</span><span class="fl">1</span>, data<span class="op">=</span><span class="va">umf</span>, chains<span class="op">=</span><span class="fl">3</span>, iter<span class="op">=</span><span class="fl">500</span>, cores<span class="op">=</span><span class="fl">3</span>, seed<span class="op">=</span><span class="fl">123</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## stan_occu(formula = ~1 ~ 1, data = umf, chains = 3, iter = 500, </span></span>
<span><span class="co">##     refresh = 0, seed = 123)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Occupancy (logit-scale):</span></span>
<span><span class="co">##  Estimate    SD   2.5% 97.5% n_eff Rhat</span></span>
<span><span class="co">##     -0.49 0.245 -0.884  0.03   217    1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Detection (logit-scale):</span></span>
<span><span class="co">##  Estimate    SD  2.5% 97.5% n_eff Rhat</span></span>
<span><span class="co">##    -0.638 0.228 -1.11 -0.21   267    1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## LOOIC: 512.113</span></span>
<span><span class="co">## Runtime: 1.585 sec</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="compare-results">Compare results<a class="anchor" aria-label="anchor" href="#compare-results"></a>
</h4>
<p>The structure of the output from <code>unmarked</code> and <code>ubms</code> is intentionally similar. Estimates of the occupancy and detection parameters are also similar, but not identical. For a more direct comparison, call the <code>coef</code> function on both model objects:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>unmarked<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit_unm</span><span class="op">)</span>, stan<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit_stan</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            unmarked       stan</span></span>
<span><span class="co">## psi(Int) -0.5461203 -0.4897345</span></span>
<span><span class="co">## p(Int)   -0.5939612 -0.6375753</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="understanding-the-ubms-output-summary">Understanding the ubms output summary<a class="anchor" aria-label="anchor" href="#understanding-the-ubms-output-summary"></a>
</h4>
<p>Let’s look at the output from our <code>fit_stan</code> model again:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_stan</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## stan_occu(formula = ~1 ~ 1, data = umf, chains = 3, iter = 500, </span></span>
<span><span class="co">##     refresh = 0, seed = 123)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Occupancy (logit-scale):</span></span>
<span><span class="co">##  Estimate    SD   2.5% 97.5% n_eff Rhat</span></span>
<span><span class="co">##     -0.49 0.245 -0.884  0.03   217    1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Detection (logit-scale):</span></span>
<span><span class="co">##  Estimate    SD  2.5% 97.5% n_eff Rhat</span></span>
<span><span class="co">##    -0.638 0.228 -1.11 -0.21   267    1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## LOOIC: 512.113</span></span>
<span><span class="co">## Runtime: 1.585 sec</span></span></code></pre>
<p>The first part (under <code>Call:</code>) is the command we used to get this model output. Underneath are two tables, one per submodel, corresponding to the occupancy and detection parts of the model. Within each table there is one row per parameter in the submodel. Since <code>fit_stan</code> had no covariates, there is only an intercept term for each submodel. Model parameters in this summary table are always shown on the appropriate transformed scale, in this case logit. To get the corresponding probabilities, you can use the <code>predict</code> function, which we will demonstrate later.</p>
<p>For each parameter, the mean and standard deviation of the posterior distribution are given. Unlike <code>unmarked</code> output, there is no <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Z</mi><annotation encoding="application/x-tex">Z</annotation></semantics></math> or <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math>-value. Instead, there is a 95% <a href="https://statmodeling.stat.columbia.edu/2016/11/26/reminder-instead-confidence-interval-lets-say-uncertainty-interval/" class="external-link">uncertainty interval</a> provided.</p>
<p>The final two columns in each summary table <code>n_eff</code> and <code>Rhat</code> are MCMC diagnostics. We will discuss their meaning later.</p>
</div>
<div class="section level4">
<h4 id="extracting-individual-parameters">Extracting individual parameters<a class="anchor" aria-label="anchor" href="#extracting-individual-parameters"></a>
</h4>
<p>To extract summary values into an R table for easy manipulation, use the <code>summary</code> method. Note that you have to specify which submodel you want (<code>"state"</code> for occupancy or <code>"det"</code> for detection).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sum_tab</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_stan</span>, <span class="st">"state"</span><span class="op">)</span></span>
<span><span class="va">sum_tab</span><span class="op">$</span><span class="va">mean</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -0.4897345</span></span></code></pre>
<p>To extract the entire posterior for a parameter, use the <code>extract</code> method. To avoid name collisions you need to use the full name of the parameter (which contains both the submodel and the parameter name) when extracting. To see a list of the available full parameter names, use the <code>names</code> method.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fit_stan</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "beta_state[(Intercept)]" "beta_det[(Intercept)]"</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">occ_intercept</span> <span class="op">&lt;-</span> <span class="fu">extract</span><span class="op">(</span><span class="va">fit_stan</span>, <span class="st">"beta_state[(Intercept)]"</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">occ_intercept</span>, freq<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/lines.html" class="external-link">lines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/density.html" class="external-link">density</a></span><span class="op">(</span><span class="va">occ_intercept</span><span class="op">)</span>, col<span class="op">=</span><span class="st">'red'</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="ubms_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
</div>
<div class="section level3">
<h3 id="compare-candidate-models">Compare candidate models<a class="anchor" aria-label="anchor" href="#compare-candidate-models"></a>
</h3>
<p>Now we’ll fit two candidate models to the <code>crossbill</code> data in <code>ubms</code> and compare them.</p>
<div class="section level4">
<h4 id="fit-the-models">Fit the models<a class="anchor" aria-label="anchor" href="#fit-the-models"></a>
</h4>
<p>Along with our previous null model, we’ll fit a “global” model with both site and observation covariates. This is just an example; perhaps other models should also be considered if we were preparing this analysis for publication. In our model formulas, we have normalized all covariates with <code>scale</code> so they have a mean of 0 and a standard deviation of 1. This can help improve model convergence and is generally a good idea.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_null</span> <span class="op">&lt;-</span> <span class="va">fit_stan</span></span>
<span></span>
<span><span class="va">fit_global</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_occu.html">stan_occu</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">forest</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">ele</span><span class="op">)</span>, data<span class="op">=</span><span class="va">umf</span>,</span>
<span>                        chains<span class="op">=</span><span class="fl">3</span>, iter<span class="op">=</span><span class="fl">500</span>, seed<span class="op">=</span><span class="fl">123</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Bulk Effective Samples Size (ESS) is too low, indicating posterior means and medians may be unreliable.</span></span>
<span><span class="co">## Running the chains for more iterations may help. See</span></span>
<span><span class="co">## https://mc-stan.org/misc/warnings.html#bulk-ess</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Tail Effective Samples Size (ESS) is too low, indicating posterior variances and tail quantiles may be unreliable.</span></span>
<span><span class="co">## Running the chains for more iterations may help. See</span></span>
<span><span class="co">## https://mc-stan.org/misc/warnings.html#tail-ess</span></span></code></pre>
<p>The <code>fit_global</code> model gave us some warnings about the effective sample size (<code>n_eff</code>) along with a suggested solution. We will ignore this warning for now but normally it is a good idea to pay close attention to these warnings.</p>
</div>
<div class="section level4">
<h4 id="compare-the-models">Compare the models<a class="anchor" aria-label="anchor" href="#compare-the-models"></a>
</h4>
<p>First we combine the models into a <code>fitList</code>:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fitList-ubmsFit-method.html">fitList</a></span><span class="op">(</span><span class="va">fit_null</span>, <span class="va">fit_global</span><span class="op">)</span></span></code></pre></div>
<p>Then we generate a model selection table:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://hmecology.github.io/unmarked/reference/modSel.html" class="external-link">modSel</a></span><span class="op">(</span><span class="va">mods</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                elpd nparam elpd_diff se_diff weight</span></span>
<span><span class="co">## fit_global -236.428  5.616     0.000   0.000  0.953</span></span>
<span><span class="co">## fit_null   -256.056  2.614   -19.628   6.635  0.047</span></span></code></pre>
<p>Instead of AIC, models are compared using leave-one-out cross-validation (LOO) <span class="citation">(Vehtari, Gelman, and Gabry <a href="#ref-Vehtari_2017" role="doc-biblioref">2017</a>)</span> via the <code>loo</code> package. Based on this cross-validation, the expected predictive accuracy (<code>elpd</code>) for each model is calculated. The model with the largest <code>elpd</code> (<code>fit_global</code>) performed best. The <code>elpd_diff</code> column shows the difference in <code>elpd</code> between a model and the top model; if this difference is several times larger than the standard error of the difference (<code>se_diff</code>), we are confident the model with the larger <code>elpd</code> performed better. LOO model weights, analogous to AIC weights, are also calculated. We can see that the <code>fit_global</code> model is clearly the best performing model.</p>
<p>You can obtain LOO information for a single model using the <code>loo</code> method:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">loo</span><span class="op">(</span><span class="va">fit_global</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Computed from 750 by 245 log-likelihood matrix.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##          Estimate   SE</span></span>
<span><span class="co">## elpd_loo   -236.4 19.3</span></span>
<span><span class="co">## p_loo         5.6  0.6</span></span>
<span><span class="co">## looic       472.9 38.6</span></span>
<span><span class="co">## ------</span></span>
<span><span class="co">## MCSE of elpd_loo is 0.1.</span></span>
<span><span class="co">## MCSE and ESS estimates assume MCMC draws (r_eff in [0.2, 1.4]).</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## All Pareto k estimates are good (k &lt; 0.65).</span></span>
<span><span class="co">## See help('pareto-k-diagnostic') for details.</span></span></code></pre>
<p>The <code>looic</code> value is analogous to AIC.</p>
<p>You can also obtain the WAIC (Widely Applicable Information Criterion) if you prefer <span class="citation">(Vehtari, Gelman, and Gabry <a href="#ref-Vehtari_2017" role="doc-biblioref">2017</a>)</span>:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">waic</span><span class="op">(</span><span class="va">fit_global</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Computed from 750 by 245 log-likelihood matrix.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##           Estimate   SE</span></span>
<span><span class="co">## elpd_waic   -236.4 19.3</span></span>
<span><span class="co">## p_waic         5.6  0.6</span></span>
<span><span class="co">## waic         472.8 38.6</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="diagnostics-and-model-fit">Diagnostics and model fit<a class="anchor" aria-label="anchor" href="#diagnostics-and-model-fit"></a>
</h3>
<p>We’ll define the global model as our top model:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_top</span> <span class="op">&lt;-</span> <span class="va">fit_global</span></span>
<span><span class="va">fit_top</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## stan_occu(formula = ~scale(date) ~ scale(forest) + scale(ele), </span></span>
<span><span class="co">##     data = umf, chains = 3, iter = 500, refresh = 0, seed = 123)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Occupancy (logit-scale):</span></span>
<span><span class="co">##               Estimate    SD   2.5% 97.5% n_eff Rhat</span></span>
<span><span class="co">## (Intercept)     -0.642 0.343 -1.199 0.258   176 1.01</span></span>
<span><span class="co">## scale(forest)    1.067 0.296  0.581 1.818   192 1.02</span></span>
<span><span class="co">## scale(ele)       0.576 0.234  0.125 1.005   497 1.00</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Detection (logit-scale):</span></span>
<span><span class="co">##             Estimate    SD   2.5%  97.5% n_eff Rhat</span></span>
<span><span class="co">## (Intercept)   -0.739 0.246 -1.241 -0.319   224 1.01</span></span>
<span><span class="co">## scale(date)    0.551 0.168  0.227  0.889   741 1.00</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## LOOIC: 472.856</span></span>
<span><span class="co">## Runtime: 2.143 sec</span></span></code></pre>
<div class="section level4">
<h4 id="mcmc-diagnostics">MCMC diagnostics<a class="anchor" aria-label="anchor" href="#mcmc-diagnostics"></a>
</h4>
<p>Again looking at the summary of <code>fit_top</code>, we conclude MCMC chains have converged if all <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>R</mi><mo accent="true">̂</mo></mover><mo>&gt;</mo><mn>1.05</mn></mrow><annotation encoding="application/x-tex">\hat{R} &gt; 1.05</annotation></semantics></math>. To visualize convergence, look at the traceplots:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://kenkellner.com/jagsUI/reference/traceplot.html" class="external-link">traceplot</a></span><span class="op">(</span><span class="va">fit_top</span>, pars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"beta_state"</span>, <span class="st">"beta_det"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="ubms_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<p>The traceplots look a little messy. We may also get a warning that <code>n_eff</code> is lacking for some parameters. The rule of thumb is to have <code>n_eff</code> &gt; 100 * number of chains (300). The easy solution to both problems would be to re-run this model with more iterations.</p>
</div>
<div class="section level4">
<h4 id="model-fit">Model fit<a class="anchor" aria-label="anchor" href="#model-fit"></a>
</h4>
<p>Calculating residuals is tricky for occupancy models. There isn’t one widely accepted way of doing it. <code>ubms</code> implements the approach of Wright <span class="citation">(Wright, Irvine, and Higgs <a href="#ref-Wright_2019" role="doc-biblioref">2019</a>)</span> in which residuals are calculated separately for the state and observation processes. To quickly plot residuals against fitted values, use the <code>plot</code> method:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_residuals-ubmsFit-method.html">plot_residuals</a></span><span class="op">(</span><span class="va">fit_top</span>, submodel<span class="op">=</span><span class="st">"state"</span><span class="op">)</span></span></code></pre></div>
<p><img src="ubms_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
<p>Note that the residuals are automatically binned, which is appropriate for a binomial response <span class="citation">(Gelman and Hill <a href="#ref-Gelman2007" role="doc-biblioref">2007</a>)</span>. If the model fits the data well, you would expect 95% of the binned residual points to fall within the shaded area. You can also plot residuals against covariate values using the <code>plot_residuals</code> function:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_residuals-ubmsFit-method.html">plot_residuals</a></span><span class="op">(</span><span class="va">fit_top</span>, submodel<span class="op">=</span><span class="st">"state"</span>, covariate<span class="op">=</span><span class="st">"forest"</span><span class="op">)</span></span></code></pre></div>
<p><img src="ubms_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p><code>ubms</code> also supports goodness-of-fit tests (posterior predictive checks) for some models. In the case of occupancy models, there is support for the MacKenzie-Bailey (M-B) chi-square test <span class="citation">(MacKenzie and Bailey <a href="#ref-MacKenzie_2004a" role="doc-biblioref">2004</a>)</span> via the <code>gof</code> function. For each posterior draw, the M-B statistic is calculated for the actual data and for a simulated dataset. The proportion of draws for which the simulated statistic is larger than the actual statistic should be near 0.5 if the model fits well.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">fit_top_gof</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gof.html">gof</a></span><span class="op">(</span><span class="va">fit_top</span>, draws<span class="op">=</span><span class="fl">100</span>, quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## MacKenzie-Bailey Chi-square </span></span>
<span><span class="co">## Point estimate = 27.188</span></span>
<span><span class="co">## Posterior predictive p = 0</span></span></code></pre>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_top_gof</span><span class="op">)</span></span></code></pre></div>
<p><img src="ubms_files/figure-html/unnamed-chunk-26-1.png" width="700"></p>
<p>Our model does not appear to fit well based on this posterior predictive check. The first step to addressing this would be to run the model for more iterations to make sure that isn’t the reason.</p>
<p>You can use the <code>posterior_predict</code> function to simulate new datasets, which you can use to calculate your own fit statistic. The following command generates 100 simulated datasets.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim_y</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posterior_predict-ubmsFit-method.html">posterior_predict</a></span><span class="op">(</span><span class="va">fit_top</span>, <span class="st">"y"</span>, draws<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">sim_y</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 100 801</span></span></code></pre>
<p>The output is a matrix with dimensions draws x observations (in site-major order). As an example, we can calculate the proportion of zeros in each simulated dataset</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prop0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">sim_y</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">==</span><span class="fl">0</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>and compare that to the proportion of zeros in the actual dataset.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">actual_prop0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://hmecology.github.io/unmarked/reference/unmarkedFrame-class.html" class="external-link">getY</a></span><span class="op">(</span><span class="va">fit_top</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Compare</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/hist.html" class="external-link">hist</a></span><span class="op">(</span><span class="va">prop0</span>, col<span class="op">=</span><span class="st">'gray'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">actual_prop0</span>, col<span class="op">=</span><span class="st">'red'</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="ubms_files/figure-html/unnamed-chunk-29-1.png" width="700"></p>
</div>
</div>
<div class="section level3">
<h3 id="model-inference">Model inference<a class="anchor" aria-label="anchor" href="#model-inference"></a>
</h3>
<div class="section level4">
<h4 id="marginal-covariate-effects">Marginal covariate effects<a class="anchor" aria-label="anchor" href="#marginal-covariate-effects"></a>
</h4>
<p>Based on the 95% uncertainty intervals, both forest and elevation have a positive effect on occupancy probability (both intervals do not contain 0). Similarly, Julian date has a positive impact on detection probability. We can quickly visualize these marginal covariate effects with the <code>plot_effects</code> function:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_effects-ubmsFit-method.html">plot_effects</a></span><span class="op">(</span><span class="va">fit_top</span>, <span class="st">"state"</span><span class="op">)</span></span></code></pre></div>
<p><img src="ubms_files/figure-html/unnamed-chunk-30-1.png" width="700"></p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_effects-ubmsFit-method.html">plot_effects</a></span><span class="op">(</span><span class="va">fit_top</span>, <span class="st">"det"</span><span class="op">)</span></span></code></pre></div>
<p><img src="ubms_files/figure-html/unnamed-chunk-30-2.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="predict-parameter-values">Predict parameter values<a class="anchor" aria-label="anchor" href="#predict-parameter-values"></a>
</h4>
<p>As with <code>unmarked</code>, we can get the predicted <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>s</mi><mi>i</mi></mrow><annotation encoding="application/x-tex">psi</annotation></semantics></math> or <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>p</mi><annotation encoding="application/x-tex">p</annotation></semantics></math> for each site or observation using the <code>predict</code> function. For example, to get occupancy:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="../reference/predict-ubmsFit-method.html">predict</a></span><span class="op">(</span><span class="va">fit_top</span>, submodel<span class="op">=</span><span class="st">"state"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    Predicted         SD       2.5%     97.5%</span></span>
<span><span class="co">## 1 0.08110111 0.03840137 0.02642961 0.1782830</span></span>
<span><span class="co">## 2 0.14687568 0.06255350 0.06060245 0.3219042</span></span>
<span><span class="co">## 3 0.29923634 0.07545430 0.18547668 0.5084098</span></span>
<span><span class="co">## 4 0.14150632 0.04446555 0.06896512 0.2535439</span></span>
<span><span class="co">## 5 0.34263769 0.07946842 0.22378228 0.5637004</span></span>
<span><span class="co">## 6 0.08427146 0.03775263 0.02945844 0.1791640</span></span></code></pre>
<p>You can also supply newdata as a <code>data.frame</code>.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ele<span class="op">=</span><span class="fl">100</span>, forest<span class="op">=</span><span class="fl">25</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/predict-ubmsFit-method.html">predict</a></span><span class="op">(</span><span class="va">fit_top</span>, submodel<span class="op">=</span><span class="st">"state"</span>, newdata<span class="op">=</span><span class="va">nd</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   Predicted         SD       2.5%     97.5%</span></span>
<span><span class="co">## 1 0.1328985 0.07257275 0.04307281 0.3283848</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="simulate-latent-occupancy-states">Simulate latent occupancy states<a class="anchor" aria-label="anchor" href="#simulate-latent-occupancy-states"></a>
</h4>
<p>One of the advantages of BUGS/JAGS is that you can directly model latent parameters, such as the true unobserved occupancy state of a site <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>z</mi><annotation encoding="application/x-tex">z</annotation></semantics></math>. Using the <code>posterior_predict</code> function in <code>ubms</code>, you can generate an equivalent posterior distribution of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>z</mi><annotation encoding="application/x-tex">z</annotation></semantics></math>.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zpost</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posterior_predict-ubmsFit-method.html">posterior_predict</a></span><span class="op">(</span><span class="va">fit_top</span>, <span class="st">"z"</span>, draws<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">zpost</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 100 267</span></span></code></pre>
<p>The output has one row per posterior draw, and one column per site. The posterior of <math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>z</mi><annotation encoding="application/x-tex">z</annotation></semantics></math> can be useful for post-hoc analyses. For example, suppose you wanted to test for a difference in mean occupancy probability between sites 1-50 and sites 51-100:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">group1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">zpost</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">50</span><span class="op">]</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">group2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">zpost</span><span class="op">[</span>,<span class="fl">51</span><span class="op">:</span><span class="fl">100</span><span class="op">]</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>group<span class="op">=</span><span class="st">"group1"</span>, occ<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">group1</span><span class="op">)</span>,</span>
<span>                             lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">group1</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>                             upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">group1</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>group<span class="op">=</span><span class="st">"group2"</span>, occ<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">group2</span><span class="op">)</span>,</span>
<span>                             lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">group2</span>, <span class="fl">0.025</span><span class="op">)</span>,</span>
<span>                             upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">group2</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now plot the posterior distributions of the two means:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">plot_dat</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">group</span>, y<span class="op">=</span><span class="va">occ</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">lower</span>, ymax<span class="op">=</span><span class="va">upper</span><span class="op">)</span>, width<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Group"</span>, y<span class="op">=</span><span class="st">"Occupancy + 95% UI"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, panel.grid.minor<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>        axis.text<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">12</span><span class="op">)</span>, axis.title<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">14</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="ubms_files/figure-html/unnamed-chunk-35-1.png" width="700"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references hanging-indent">
<div id="ref-Bates_2015">
<p>Bates, Douglas, Martin Mächler, Ben Bolker, and Steve Walker. 2015. “Fitting Linear Mixed-Effects Models Using Lme4.” <em>Journal of Statistical Software</em> 67 (1). <a href="https://doi.org/10.18637/jss.v067.i01" class="external-link">https://doi.org/10.18637/jss.v067.i01</a>.</p>
</div>
<div id="ref-Carpenter_2017">
<p>Carpenter, Bob, Andrew Gelman, Matthew D. Hoffman, Daniel Lee, Ben Goodrich, Michael Betancourt, Marcus Brubaker, Jiqiang Guo, Peter Li, and Allen Riddell. 2017. “Stan: A Probabilistic Programming Language.” <em>Journal of Statistical Software</em> 76 (1). <a href="https://doi.org/10.18637/jss.v076.i01" class="external-link">https://doi.org/10.18637/jss.v076.i01</a>.</p>
</div>
<div id="ref-Chandler2011">
<p>Chandler, Richard B., J. Andrew Royle, and David I. King. 2011. “Inference About Density and Temporary Emigration in Unmarked Populations.” <em>Ecology</em> 92 (7): 1429–35. <a href="https://doi.org/10.1890/10-2433.1" class="external-link">https://doi.org/10.1890/10-2433.1</a>.</p>
</div>
<div id="ref-Fiske_2011">
<p>Fiske, Ian, Richard Chandler, and others. 2011. “Unmarked: An R Package for Fitting Hierarchical Models of Wildlife Occurrence and Abundance.” <em>Journal of Statistical Software</em> 43 (10): 1–23. <a href="https://doi.org/10.18637/jss.v043.i10" class="external-link">https://doi.org/10.18637/jss.v043.i10</a>.</p>
</div>
<div id="ref-Gelman2007">
<p>Gelman, Andrew, and Jennifer Hill. 2007. <em>Data Analysis Using Regression and Multilevel/Hierarchical Models</em>. New York, NY: Cambridge University Press.</p>
</div>
<div id="ref-Hoffman_2014">
<p>Hoffman, Matthew D, and Andrew Gelman. 2014. “The No-U-Turn Sampler: Adaptively Setting Path Lengths in Hamiltonian Monte Carlo.” <em>Journal of Machine Learning Research</em> 15 (1): 1593–1623.</p>
</div>
<div id="ref-MacKenzie_2004a">
<p>MacKenzie, Darryl I., and Larissa L. Bailey. 2004. “Assessing the Fit of Site-Occupancy Models.” <em>Journal of Agricultural, Biological, and Environmental Statistics</em> 9 (3): 300–318. <a href="https://doi.org/10.1198/108571104x3361" class="external-link">https://doi.org/10.1198/108571104x3361</a>.</p>
</div>
<div id="ref-MacKenzie_2002">
<p>MacKenzie, Darryl I., James D. Nichols, Gideon B. Lachman, Sam Droege, J. Andrew Royle, and Catherine A. Langtimm. 2002. “Estimating Site Occupancy Rates When Detection Probabilities Are Less Than One.” <em>Ecology</em> 83 (8): 2248–55. <a href="https://doi.org/10.1890/0012-9658(2002)083%5B2248:esorwd%5D2.0.co;2" class="external-link">https://doi.org/10.1890/0012-9658(2002)083[2248:esorwd]2.0.co;2</a>.</p>
</div>
<div id="ref-Schmid_2004">
<p>Schmid, Hans, Niklaus Zbinden, and Verena Keller. 2004. “Überwachung Der Bestandsentwicklung Häufiger Brutvögel in Der Schweiz.” <em>Swiss Ornithological Institute Sempach Switzerland</em>.</p>
</div>
<div id="ref-Vehtari_2017">
<p>Vehtari, Aki, Andrew Gelman, and Jonah Gabry. 2017. “Practical Bayesian Model Evaluation Using Leave-One-Out Cross-Validation and WAIC.” <em>Statistics and Computing</em> 27 (5): 1413–32. <a href="https://doi.org/10.1007/s11222-016-9696-4" class="external-link">https://doi.org/10.1007/s11222-016-9696-4</a>.</p>
</div>
<div id="ref-Wright_2019">
<p>Wright, Wilson J., Kathryn M. Irvine, and Megan D. Higgs. 2019. “Identifying Occupancy Model Inadequacies: Can Residuals Separately Assess Detection and Presence?” <em>Ecology</em>, e02703. <a href="https://doi.org/10.1002/ecy.2703" class="external-link">https://doi.org/10.1002/ecy.2703</a>.</p>
</div>
<div id="ref-Yackulic_2020">
<p>Yackulic, Charles B., Michael Dodrill, Maria Dzul, Jamie S. Sanderlin, and Janice A. Reid. 2020. “A Need for Speed in Bayesian Population Models: A Practical Guide to Marginalizing and Recovering Discrete Latent States.” <em>Ecological Applications</em> 30 (5). <a href="https://doi.org/10.1002/eap.2112" class="external-link">https://doi.org/10.1002/eap.2112</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://kenkellner.com" class="external-link">Ken Kellner</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
