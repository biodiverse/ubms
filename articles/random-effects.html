<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Random effects in ubms • ubms</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Random effects in ubms">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ubms</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.2.6</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/ubms.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/JAGS-comparison.html">Comparing models fit in ubms and JAGS</a>
    </li>
    <li>
      <a href="../articles/random-effects.html">Random effects in ubms</a>
    </li>
    <li>
      <a href="../articles/spatial-models.html">Spatial Models in ubms</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/kenkellner/ubms/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><script src="random-effects_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Random effects in ubms</h1>
                        <h4 data-toc-skip class="author">Ken Kellner</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/kenkellner/ubms/blob/HEAD/vignettes/random-effects.Rmd" class="external-link"><code>vignettes/random-effects.Rmd</code></a></small>
      <div class="hidden name"><code>random-effects.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<div class="section level3">
<h3 id="random-effects-in-ubms">Random effects in <code>ubms</code><a class="anchor" aria-label="anchor" href="#random-effects-in-ubms"></a>
</h3>
<p>The <code>ubms</code> package fits models of wildlife occurrence and abundance in <a href="https://mc-stan.org/" class="external-link">Stan</a> <span class="citation">(Carpenter et al. <a href="#ref-Carpenter_2017" role="doc-biblioref">2017</a>)</span>, in a similar fashion to the <code>unmarked</code> package <span class="citation">(Fiske, Chandler, and others <a href="#ref-Fiske_2011" role="doc-biblioref">2011</a>)</span>. One of the advantages of <code>ubms</code> is that it is possible to include random effects in your models, using the same syntax as <a href="https://cran.r-project.org/package=lme4" class="external-link">lme4</a> <span class="citation">(Bates et al. <a href="#ref-Bates_2015" role="doc-biblioref">2015</a>)</span>. For example, if you have a <code>group</code> site covariate, you can fit a model with random intercepts by <code>group</code> by including <code>+ (1|group)</code> in your parameter formula. Random slopes, or a combination of random slopes and intercepts, are also possible. To illustrate the use of random effects of <code>ubms</code>, this vignette fits a model to multi-season occupancy data using a “stacked” approach.</p>
</div>
<div class="section level3">
<h3 id="stacked-models">“Stacked” Models<a class="anchor" aria-label="anchor" href="#stacked-models"></a>
</h3>
<p>Suppose you have a dataset of repeated detections/non-detections or counts that are collected over several primary periods (i.e., seasons). The logical model choice for such data is a multi-season model, such as the dynamic occupancy model <span class="citation">(MacKenzie et al. <a href="#ref-MacKenzie_2003" role="doc-biblioref">2003</a>)</span> or some form of Dail-Madsen model for count data <span class="citation">(Dail and Madsen <a href="#ref-Dail_2011" role="doc-biblioref">2011</a>)</span>. These models estimate transition probabilities such as colonization and extinction rates between seasons.</p>
<p>However, in some cases you might not want to fit a dynamic model. There are several potential reasons for this: (1) You don’t have enough data (Dail-Madsen type models are particularly data hungry); (2) You aren’t interested in the transition probabilities; or (3) The dynamic model type you need isn’t available in theory or in your software package of choice.</p>
<p>An alternative approach is to fit multiple years of data into a single-season model using the “stacked” approach. Essentially, you treat unique site-year combinations as sites. For a helpful discussion on the topic, see <a href="https://groups.google.com/forum/#!topic/unmarked/OHkk98y09Zo" class="external-link">this</a> thread on the <code>unmarked</code> forums.</p>
<p>Ideally you want to control for the pseudoreplication this creates in some form. In <code>unmarked</code> you are limited to approaches such as including a dummy variable for site and/or year. In <code>ubms</code> you can instead include, for example, random site intercepts to account for this pseudoreplication.</p>
</div>
</div>
<div class="section level2">
<h2 id="fitting-a-stacked-model-with-ubms">Fitting a stacked model with <code>ubms</code><a class="anchor" aria-label="anchor" href="#fitting-a-stacked-model-with-ubms"></a>
</h2>
<div class="section level3">
<h3 id="read-in-the-input-data">Read in the input data<a class="anchor" aria-label="anchor" href="#read-in-the-input-data"></a>
</h3>
<p>We will use the <code>crossbill</code> dataset to illustrate a stacked occupancy model with a site-level random effect. The <code>crossbill</code> dataset comes packaged with <code>ubms</code> via <code>unmarked</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kenkellner.com/ubms/" class="external-link">ubms</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">crossbill</span><span class="op">)</span></span></code></pre></div>
<p>The <code>crossbill</code> dataset is a <code>data.frame</code> with many columns. It contains 9 years of detection/non-detection data for the European crossbill (<em>Loxia curvirostra</em>) in Switzerland <span class="citation">(Schmid, Zbinden, and Keller <a href="#ref-Schmid_2004" role="doc-biblioref">2004</a>)</span>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">crossbill</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 267  58</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">crossbill</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "id"      "ele"     "forest"  "surveys" "det991"  "det992"  "det993" </span></span>
<span><span class="co">##  [8] "det001"  "det002"  "det003"  "det011"  "det012"  "det013"  "det021" </span></span>
<span><span class="co">## [15] "det022"  "det023"  "det031"  "det032"  "det033"  "det041"  "det042" </span></span>
<span><span class="co">## [22] "det043"  "det051"  "det052"  "det053"  "det061"  "det062"  "det063" </span></span>
<span><span class="co">## [29] "det071"  "det072"  "det073"  "date991" "date992" "date993" "date001"</span></span>
<span><span class="co">## [36] "date002" "date003" "date011" "date012" "date013" "date021" "date022"</span></span>
<span><span class="co">## [43] "date023" "date031" "date032" "date033" "date041" "date042" "date043"</span></span>
<span><span class="co">## [50] "date051" "date052" "date053" "date061" "date062" "date063" "date071"</span></span>
<span><span class="co">## [57] "date072" "date073"</span></span></code></pre>
<p>Check <code><a href="https://hmecology.github.io/unmarked/reference/crossbill.html" class="external-link">?crossbill</a></code> for details about each column. The first three columns <code>id</code>, <code>ele</code>, and <code>forest</code> are site covariates.</p>
<p>The following 27 columns beginning with <code>det</code> are the binary detection/non-detection data; 9 years with 3 observations per year. The final 27 columns beginning with <code>date</code> are the Julian dates for each observation.</p>
</div>
<div class="section level3">
<h3 id="convert-the-input-data-to-stacked-format">Convert the input data to stacked format<a class="anchor" aria-label="anchor" href="#convert-the-input-data-to-stacked-format"></a>
</h3>
<p>We will use the first 3 years of <code>crossbill</code> data (instead of all 9), simply to keep the analysis run time down. Converting the <code>crossbill</code> data to stacked format is a bit complex. The dataset contains 267 unique sites; thus after stacking we should end up with a response variable and covariates that contain <code>267 * 3 = 801</code> “sites” (actually site-years). We will order this new dataset so that the first 267 rows are the sites in year 1, the 2nd 267 rows are the sites in year 2, and so on.</p>
<p>Handling the site-level covariates (which do not change between years) is the easiest task. We simply replicate the set of site covariates (which contains one row for each of the original 267 sites) one time per season, and stack each replicate on top of each other vertically with <code>rbind</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">site_covs</span> <span class="op">&lt;-</span> <span class="va">crossbill</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"ele"</span>, <span class="st">"forest"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">sc_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">site_covs</span>, <span class="va">site_covs</span>, <span class="va">site_covs</span><span class="op">)</span></span></code></pre></div>
<p>We also want to add a factor column called <code>site</code> to the stacked site covariates that identifies the original site number of each row. We will use this later as our grouping factor for the random effect</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sc_stack</span><span class="op">$</span><span class="va">site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">site_covs</span><span class="op">)</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sc_stack</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   id  ele forest site</span></span>
<span><span class="co">## 1  1  450      3    1</span></span>
<span><span class="co">## 2  2  450     21    2</span></span>
<span><span class="co">## 3  3 1050     32    3</span></span>
<span><span class="co">## 4  4  950      9    4</span></span>
<span><span class="co">## 5  5 1150     35    5</span></span>
<span><span class="co">## 6  6  550      2    6</span></span></code></pre>
<p>Stacking the response variable and the observation covariates is harder. Our dataset is in a “wide” format where each row is a site and each observation is a column, with columns 1-3 corresponding to year 1, 4-6 to year 2, and so on. Here is a function that splits a “wide” dataset like this into pieces and stacks them on top of each other.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wide_to_stacked</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input_df</span>, <span class="va">nyears</span>, <span class="va">surveys_per_year</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">nyears</span><span class="op">*</span><span class="va">surveys_per_year</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nyears</span>, each<span class="op">=</span><span class="va">surveys_per_year</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">split_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nyears</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span><span class="op">{</span></span>
<span>                      <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">input_df</span><span class="op">[</span>,<span class="va">inds</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span>
<span>                      <span class="va">out</span><span class="op">$</span><span class="va">site</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">input_df</span><span class="op">)</span></span>
<span>                      <span class="va">out</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="va">i</span></span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"obs"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span></span>
<span>                      <span class="va">out</span></span>
<span>              <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="va">stack_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">split_df</span><span class="op">)</span></span>
<span>  <span class="va">stack_df</span><span class="op">$</span><span class="va">site</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">stack_df</span><span class="op">$</span><span class="va">site</span><span class="op">)</span></span>
<span>  <span class="va">stack_df</span><span class="op">$</span><span class="va">year</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">stack_df</span><span class="op">$</span><span class="va">year</span><span class="op">)</span></span>
<span>  <span class="va">stack_df</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This function can be used to convert both the detection/non-detection data and observation covariates to the stacked format. First, we isolate the detection/non-detection data in <code>crossbill</code>:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_wide</span> <span class="op">&lt;-</span> <span class="va">crossbill</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"det"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">crossbill</span><span class="op">)</span>, value<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Next we convert it to stacked format, specifying that we want only the first 3 years, and that each year has 3 observations/surveys:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">y_stack</span> <span class="op">&lt;-</span> <span class="fu">wide_to_stacked</span><span class="op">(</span><span class="va">y_wide</span>, nyears<span class="op">=</span><span class="fl">3</span>, surveys_per_year<span class="op">=</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">y_stack</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 801   5</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">y_stack</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   obs1 obs2 obs3 site year</span></span>
<span><span class="co">## 1    0    0    0    1    1</span></span>
<span><span class="co">## 2    0    0    0    2    1</span></span>
<span><span class="co">## 3   NA   NA   NA    3    1</span></span>
<span><span class="co">## 4    0    0    0    4    1</span></span>
<span><span class="co">## 5    0    0    0    5    1</span></span>
<span><span class="co">## 6   NA   NA   NA    6    1</span></span></code></pre>
<p>Finally, we do the same with the <code>date</code> observation covariate.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">date_wide</span> <span class="op">&lt;-</span> <span class="va">crossbill</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"date"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">crossbill</span><span class="op">)</span>, value<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">date_stack</span> <span class="op">&lt;-</span> <span class="fu">wide_to_stacked</span><span class="op">(</span><span class="va">date_wide</span>, <span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">date_stack</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 801   5</span></span></code></pre>
<p>With our stacked datasets constructed, we build our <code>unmarkedFrame</code>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umf_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://hmecology.github.io/unmarked/reference/unmarkedFrameOccu.html" class="external-link">unmarkedFrameOccu</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">y_stack</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span>, siteCovs<span class="op">=</span><span class="va">sc_stack</span>,</span>
<span>                         obsCovs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>date<span class="op">=</span><span class="va">date_stack</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">umf_stack</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Data frame representation of unmarkedFrame object.</span></span>
<span><span class="co">##    y.1 y.2 y.3 id  ele forest site date.1 date.2 date.3</span></span>
<span><span class="co">## 1    0   0   0  1  450      3    1     34     59     65</span></span>
<span><span class="co">## 2    0   0   0  2  450     21    2     17     33     65</span></span>
<span><span class="co">## 3   NA  NA  NA  3 1050     32    3     NA     NA     NA</span></span>
<span><span class="co">## 4    0   0   0  4  950      9    4     29     59     65</span></span>
<span><span class="co">## 5    0   0   0  5 1150     35    5     24     45     65</span></span>
<span><span class="co">## 6   NA  NA  NA  6  550      2    6     NA     NA     NA</span></span>
<span><span class="co">## 7    0   0   0  7  750      6    7     26     54     74</span></span>
<span><span class="co">## 8    0   0   0  8  650     60    8     23     43     71</span></span>
<span><span class="co">## 9    0   0   0  9  550      5    9     21     36     56</span></span>
<span><span class="co">## 10   0   0   0 10  550     13   10     37     62     75</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="fit-the-stacked-model">Fit the Stacked Model<a class="anchor" aria-label="anchor" href="#fit-the-stacked-model"></a>
</h3>
<p>We’ll now fit a model with fixed effects of elevation and forest cover (<code>ele</code> and <code>forest</code>) on occupancy and a <code>date</code> effect on detection. In addition, we will include random intercepts by <code>site</code>, since in stacking the data we have pseudoreplication by site. To review, random effects are specified using the approach used in with the <code>lme4</code> package. For example, a random intercept for each level of the covariate <code>site</code> is specified with the formula component <code>(1|site)</code>. Including random effects in a model in <code>ubms</code> usually significantly increases the run time.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_stack</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/stan_occu.html">stan_occu</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">ele</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="va">forest</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">site</span><span class="op">)</span>, </span>
<span>                       data<span class="op">=</span><span class="va">umf_stack</span>, chains<span class="op">=</span><span class="fl">3</span>, iter<span class="op">=</span><span class="fl">500</span><span class="op">)</span></span>
<span><span class="va">fit_stack</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## stan_occu(formula = ~scale(date) ~ scale(ele) + scale(forest) + </span></span>
<span><span class="co">##     (1 | site), data = umf_stack, chains = 3, iter = 500, refresh = 0)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Occupancy (logit-scale):</span></span>
<span><span class="co">##                Estimate    SD   2.5% 97.5% n_eff  Rhat</span></span>
<span><span class="co">## (Intercept)       -1.60 0.218 -2.061 -1.21   146 0.998</span></span>
<span><span class="co">## scale(ele)         1.13 0.217  0.729  1.55   312 1.004</span></span>
<span><span class="co">## scale(forest)      1.49 0.223  1.066  1.94   109 1.002</span></span>
<span><span class="co">## sigma [1|site]     1.95 0.319  1.387  2.66    44 1.011</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Detection (logit-scale):</span></span>
<span><span class="co">##             Estimate     SD     2.5% 97.5% n_eff  Rhat</span></span>
<span><span class="co">## (Intercept)    0.182 0.0980 -0.00664 0.372  1082 0.998</span></span>
<span><span class="co">## scale(date)    0.337 0.0886  0.15452 0.500  1767 0.997</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## LOOIC: 1473.761</span></span></code></pre>
<p>We get warnings; these should be fixed by increasing the iterations. In addition to fixed effect estimates, we now have an estimate for the site-level variance (<code>sigma [1|site]</code>) in our summary table.</p>
</div>
<div class="section level3">
<h3 id="accessing-the-random-intercepts">Accessing the random intercepts<a class="anchor" aria-label="anchor" href="#accessing-the-random-intercepts"></a>
</h3>
<p>In order to get the actual random intercept values, we use the <code>ranef</code> function. Note that this function behaves like the <code>lme4</code> version, not like the <code>unmarked</code> version. A further caution is that when using an effects parameterization, <code>ranef</code> always returns the complete random intercept/slope term for a group (i.e., the mean + random effect, not just the random part).</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ran</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ranef-ubmsFit-method.html">ranef</a></span><span class="op">(</span><span class="va">fit_stack</span>, submodel<span class="op">=</span><span class="st">"state"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ran</span><span class="op">$</span><span class="va">site</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           1           2           3           4           5           6 </span></span>
<span><span class="co">## -1.89508002 -1.99838584 -0.30322435  0.06205105  0.39474369 -1.72122316</span></span></code></pre>
<p>You can also generate summary statistics for each random intercept:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ran</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/ranef-ubmsFit-method.html">ranef</a></span><span class="op">(</span><span class="va">fit_stack</span>, submodel<span class="op">=</span><span class="st">"state"</span>, summary<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ran</span><span class="op">$</span><span class="va">site</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      Estimate       SD      2.5%    97.5%</span></span>
<span><span class="co">## 1 -1.89508002 1.785040 -5.680523 1.561208</span></span>
<span><span class="co">## 2 -1.99838584 1.753822 -5.530354 1.201788</span></span>
<span><span class="co">## 3 -0.30322435 1.373765 -3.039763 2.464200</span></span>
<span><span class="co">## 4  0.06205105 1.336437 -2.665990 2.442716</span></span>
<span><span class="co">## 5  0.39474369 1.214734 -1.977876 3.013954</span></span>
<span><span class="co">## 6 -1.72122316 1.753082 -5.287677 1.521753</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references hanging-indent">
<div id="ref-Bates_2015">
<p>Bates, Douglas, Martin Mächler, Ben Bolker, and Steve Walker. 2015. “Fitting Linear Mixed-Effects Models Using Lme4.” <em>Journal of Statistical Software</em> 67 (1). <a href="https://doi.org/10.18637/jss.v067.i01" class="external-link">https://doi.org/10.18637/jss.v067.i01</a>.</p>
</div>
<div id="ref-Carpenter_2017">
<p>Carpenter, Bob, Andrew Gelman, Matthew D. Hoffman, Daniel Lee, Ben Goodrich, Michael Betancourt, Marcus Brubaker, Jiqiang Guo, Peter Li, and Allen Riddell. 2017. “Stan: A Probabilistic Programming Language.” <em>Journal of Statistical Software</em> 76 (1). <a href="https://doi.org/10.18637/jss.v076.i01" class="external-link">https://doi.org/10.18637/jss.v076.i01</a>.</p>
</div>
<div id="ref-Dail_2011">
<p>Dail, D., and L. Madsen. 2011. “Models for Estimating Abundance from Repeated Counts of an Open Metapopulation.” <em>Biometrics</em> 67: 577–87. <a href="https://doi.org/10.1111/j.1541-0420.2010.01465.x" class="external-link">https://doi.org/10.1111/j.1541-0420.2010.01465.x</a>.</p>
</div>
<div id="ref-Fiske_2011">
<p>Fiske, Ian, Richard Chandler, and others. 2011. “Unmarked: An R Package for Fitting Hierarchical Models of Wildlife Occurrence and Abundance.” <em>Journal of Statistical Software</em> 43 (10): 1–23. <a href="https://doi.org/10.18637/jss.v043.i10" class="external-link">https://doi.org/10.18637/jss.v043.i10</a>.</p>
</div>
<div id="ref-MacKenzie_2003">
<p>MacKenzie, Darryl I., James D. Nichols, James E. Hines, Melinda G. Knutson, and Alan B. Franklin. 2003. “Estimating Site Occupancy, Colonization, and Local Extinction When a Species Is Detected Imperfectly.” <em>Ecology</em> 84: 2200–2207. <a href="https://doi.org/10.1890/02-3090" class="external-link">https://doi.org/10.1890/02-3090</a>.</p>
</div>
<div id="ref-Schmid_2004">
<p>Schmid, Hans, Niklaus Zbinden, and Verena Keller. 2004. “Überwachung Der Bestandsentwicklung Häufiger Brutvögel in Der Schweiz.” <em>Swiss Ornithological Institute Sempach Switzerland</em>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://kenkellner.com" class="external-link">Ken Kellner</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

      </footer>
</div>






  </body>
</html>
